<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>BizTask Pro</title>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />

    <style>
      :root {
        --primary-color: #2563eb;
        --bg-color: #f1f5f9;
      }
      * {
        -webkit-tap-highlight-color: transparent;
        box-sizing: border-box;
      }
      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        background: var(--bg-color);
        padding: 20px;
        color: #334155;
        margin: 0;
        overflow-x: hidden;
      }

      .container {
        max-width: 500px;
        margin: auto;
      }
      h2 {
        text-align: center;
        margin-bottom: 20px;
        font-weight: 800;
      }

      .card {
        background: white;
        padding: 20px;
        border-radius: 16px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        margin-bottom: 20px;
      }
      .input-group {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      input[type="text"] {
        padding: 14px;
        border-radius: 10px;
        border: 1px solid #e2e8f0;
        font-size: 16px;
        width: 100%;
        background: #f8fafc;
      }

      .date-box {
        padding: 14px;
        border-radius: 10px;
        border: 1px solid #e2e8f0;
        font-size: 16px;
        background: #f8fafc;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
      }

      #dateInput {
        position: absolute;
        visibility: hidden;
        width: 0;
        height: 0;
      }

      button.add-btn {
        padding: 16px;
        border-radius: 10px;
        background: var(--primary-color);
        color: white;
        border: none;
        font-weight: bold;
        font-size: 16px;
        margin-top: 5px;
      }

      /* ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
      ul {
        list-style: none;
        padding: 0;
        margin-top: 10px;
      }
      li {
        background: white;
        padding: 16px;
        border-radius: 12px;
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        cursor: grab; /* æ´ã‚ã‚‹ã‚«ãƒ¼ã‚½ãƒ« */
        user-select: none;
        touch-action: none; /* ã‚¹ãƒãƒ›ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æŠ‘åˆ¶ */
      }
      li:active {
        cursor: grabbing;
        opacity: 0.8;
        transform: scale(0.98);
      }
      li.dragging {
        opacity: 0.5;
        background: #e2e8f0;
        border: 2px dashed #cbd5e1;
      }

      .task-date {
        font-size: 12px;
        color: #64748b;
        font-weight: bold;
        margin-top: 4px;
        display: block;
      }
      .delete-btn {
        background: #fff1f2;
        color: #e11d48;
        padding: 10px;
        border-radius: 8px;
        border: none;
        font-size: 12px;
        pointer-events: auto;
      }

      /* æ´ã‚€ãŸã‚ã®ãƒãƒ³ãƒ‰ãƒ«ï¼ˆã‚¢ã‚¤ã‚³ãƒ³ï¼‰ */
      .handle {
        color: #cbd5e1;
        margin-right: 15px;
        font-size: 20px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h2>BizTask Pro</h2>

      <div class="card">
        <div class="input-group">
          <input
            type="text"
            id="taskInput"
            placeholder="ã‚¿ã‚¹ã‚¯ã‚’å…¥åŠ›"
            autocomplete="off"
          />
          <div class="date-box" onclick="triggerCalendar()">
            <span id="dateText" style="color: #94a3b8">æœŸé™ã‚’é¸æŠ</span>
            <span>ğŸ“…</span>
          </div>
          <input type="date" id="dateInput" onchange="handleDateChange()" />
          <button class="add-btn" onclick="addTask()">è¿½åŠ ã™ã‚‹</button>
        </div>
      </div>

      <ul id="taskList"></ul>
    </div>

    <script>
      const dayNames = ["æ—¥", "æœˆ", "ç«", "æ°´", "æœ¨", "é‡‘", "åœŸ"];
      const taskList = document.getElementById("taskList");

      function triggerCalendar() {
        const input = document.getElementById("dateInput");
        input.showPicker ? input.showPicker() : input.click();
      }

      function handleDateChange() {
        const realInput = document.getElementById("dateInput");
        const dateText = document.getElementById("dateText");
        if (realInput.value) {
          const d = new Date(realInput.value);
          dateText.innerText = `${realInput.value.replace(/-/g, "/")} (${dayNames[d.getDay()]})`;
          dateText.style.color = "#1e293b";
        }
      }

      window.onload = () => {
        const savedTasks = JSON.parse(localStorage.getItem("bizTasks")) || [];
        savedTasks.forEach((task) => renderTask(task));
        initSortable();
      };

      function addTask() {
        const textInput = document.getElementById("taskInput");
        const dateInput = document.getElementById("dateInput");
        if (!textInput.value) return;

        let displayDate = "æœŸé™ãªã—";
        if (dateInput.value) {
          const d = new Date(dateInput.value);
          displayDate = `${dateInput.value.replace(/-/g, "/")} (${dayNames[d.getDay()]})`;
        }

        const newTask = {
          id: Date.now(),
          text: textInput.value,
          date: displayDate,
        };
        const tasks = JSON.parse(localStorage.getItem("bizTasks")) || [];
        tasks.push(newTask);
        localStorage.setItem("bizTasks", JSON.stringify(tasks));

        renderTask(newTask);
        textInput.value = "";
        dateInput.value = "";
        document.getElementById("dateText").innerText = "æœŸé™ã‚’é¸æŠ";
        document.getElementById("dateText").style.color = "#94a3b8";
      }

      function renderTask(task) {
        const li = document.createElement("li");
        li.setAttribute("data-id", task.id);
        li.setAttribute("draggable", "true");
        li.innerHTML = `
            <div style="display:flex; align-items:center;">
                <div class="handle">â˜°</div>
                <div>
                    <div style="font-weight:500;">${task.text}</div>
                    <span class="task-date">ğŸ“… ${task.date}</span>
                </div>
            </div>
            <button class="delete-btn" onclick="deleteTask(${task.id})">å‰Šé™¤</button>
        `;
        taskList.appendChild(li);
      }

      function deleteTask(id) {
        let tasks = JSON.parse(localStorage.getItem("bizTasks")).filter(
          (t) => t.id !== id,
        );
        localStorage.setItem("bizTasks", JSON.stringify(tasks));
        document.querySelector(`li[data-id="${id}"]`).remove();
      }

      // --- ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ— ãƒ­ã‚¸ãƒƒã‚¯ ---
      function initSortable() {
        let dragItem = null;

        // PCç”¨ã‚¤ãƒ™ãƒ³ãƒˆ
        taskList.addEventListener("dragstart", (e) => {
          dragItem = e.target;
          e.target.classList.add("dragging");
        });

        taskList.addEventListener("dragend", (e) => {
          e.target.classList.remove("dragging");
          saveOrder();
        });

        taskList.addEventListener("dragover", (e) => {
          e.preventDefault();
          const afterElement = getDragAfterElement(taskList, e.clientY);
          if (afterElement == null) {
            taskList.appendChild(dragItem);
          } else {
            taskList.insertBefore(dragItem, afterElement);
          }
        });

        // ã‚¹ãƒãƒ›ç”¨ï¼ˆã‚¿ãƒƒãƒï¼‰ã‚¤ãƒ™ãƒ³ãƒˆ
        taskList.addEventListener(
          "touchstart",
          (e) => {
            if (e.target.tagName === "BUTTON") return;
            dragItem = e.target.closest("li");
            dragItem.classList.add("dragging");
          },
          { passive: false },
        );

        taskList.addEventListener(
          "touchmove",
          (e) => {
            e.preventDefault();
            const touch = e.touches[0];
            const afterElement = getDragAfterElement(taskList, touch.clientY);
            if (afterElement == null) {
              taskList.appendChild(dragItem);
            } else {
              taskList.insertBefore(dragItem, afterElement);
            }
          },
          { passive: false },
        );

        taskList.addEventListener("touchend", () => {
          if (dragItem) {
            dragItem.classList.remove("dragging");
            saveOrder();
            dragItem = null;
          }
        });
      }

      function getDragAfterElement(container, y) {
        const draggableElements = [
          ...container.querySelectorAll("li:not(.dragging)"),
        ];
        return draggableElements.reduce(
          (closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
            if (offset < 0 && offset > closest.offset) {
              return { offset: offset, element: child };
            } else {
              return closest;
            }
          },
          { offset: Number.NEGATIVE_INFINITY },
        ).element;
      }

      function saveOrder() {
        const currentTasks = [];
        const items = taskList.querySelectorAll("li");
        const oldTasks = JSON.parse(localStorage.getItem("bizTasks"));

        items.forEach((item) => {
          const id = parseInt(item.getAttribute("data-id"));
          const task = oldTasks.find((t) => t.id === id);
          if (task) currentTasks.push(task);
        });
        localStorage.setItem("bizTasks", JSON.stringify(currentTasks));
      }
    </script>
  </body>
</html>

